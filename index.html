<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B√°o Gi√° S·ª≠a Ch·ªØa (v3.8 Import Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .price-table { min-width: 700px; } 
        .searchable-input { padding-right: 2.5rem; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(2px); }
        
        .suggestions-container {
            position: absolute; z-index: 50; background-color: white;
            border: 1px solid #e5e7eb; border-top: none; 
            max-height: 60vh; overflow-y: auto; width: 100%;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .suggestion-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f3f4f6; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #f1f5f9; }
        .active-suggestion { background-color: #e0e7ff !important; border-left: 3px solid #4f46e5; }
        
        .show-all-item {
            font-weight: bold; color: #4f46e5; text-align: center; 
            border-top: 1px solid #e5e7eb; background-color: #f9fafb; padding: 12px; cursor: pointer;
            position: sticky; bottom: 0; z-index: 10;
        }
        .show-all-item:hover { background-color: #eff6ff; }

        .z-modal { z-index: 60; }
        .z-modal-top { z-index: 70; }

        .setup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px;
        }
        
        @keyframes flashUpdate { 0% { background-color: #dcfce7; } 100% { background-color: transparent; } }
        .updated-row { animation: flashUpdate 1.5s ease-out; }

        .drag-handle { cursor: grab; color: #9ca3af; padding: 8px; border-radius: 4px; transition: background 0.2s; }
        .drag-handle:hover { background-color: #f3f4f6; color: #4b5563; }
        .drag-handle:active { cursor: grabbing; }
        .draggable-row.dragging { opacity: 0.4; background-color: #e0e7ff; border: 2px dashed #4f46e5; }
        .draggable-row.drag-over { border-top: 2px solid #4f46e5; }
    </style>
</head>
<body class="p-3 sm:p-6" onclick="clearSuggestions(event)">

    <!-- SETUP SCREEN -->
    <div id="setupScreen" class="setup-screen hidden">
        <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-2xl border border-gray-100">
            <div class="text-center mb-6">
                <div class="bg-indigo-100 p-3 rounded-full inline-block mb-4">
                    <svg class="w-10 h-10 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">K·∫øt N·ªëi Kho D·ªØ Li·ªáu</h2>
                <p class="text-gray-500 text-sm mt-2">D√°n m√£ c·∫•u h√¨nh Firebase ƒë·ªÉ ƒë·ªìng b·ªô.</p>
            </div>
            <textarea id="firebaseConfigInput" rows="5" placeholder='D√°n m√£ config v√†o ƒë√¢y...' class="w-full p-3 border border-gray-300 rounded-lg font-mono text-xs mb-4 focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
            <button onclick="saveConfiguration()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition shadow-lg transform active:scale-95">K·∫øt N·ªëi Cloud</button>
            <div class="mt-4 text-center">
                <button onclick="useOfflineMode()" class="text-gray-500 text-sm underline hover:text-indigo-600">D√πng th·ª≠ Offline</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="max-w-6xl mx-auto bg-white shadow-xl rounded-2xl p-4 sm:p-8 min-h-[80vh]">
        <div class="flex justify-between items-start mb-6 border-b border-gray-100 pb-4">
            <div>
                <h1 class="text-xl sm:text-3xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 sm:w-8 sm:h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    Tra C·ª©u Gi√° Nhanh
                </h1>
                <p class="text-xs text-gray-400 mt-1">H·ªá th·ªëng b√°o gi√° (v3.8 Stable)</p>
            </div>
            <div class="flex flex-col items-end">
                <div class="flex gap-2 mb-1">
                    <button onclick="hardResetApp()" class="text-[10px] text-red-500 bg-red-50 px-2 py-1 rounded border border-red-200 hover:bg-red-100 flex items-center" title="B·∫•m v√†o ƒë√¢y n·∫øu g·∫∑p l·ªói">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Reset L·ªói
                    </button>
                    <button onclick="resetConfig()" class="text-[10px] text-gray-400 hover:text-gray-600 bg-gray-50 px-2 py-1 rounded border border-gray-200">
                        ƒêƒÉng xu·∫•t
                    </button>
                </div>
                <div class="flex gap-2 text-xs">
                    <span id="configIdDisplay" class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-mono">ID: ---</span>
                    <span id="syncStatus" class="flex items-center bg-gray-100 px-2 py-1 rounded-full border border-gray-200">
                        <span class="w-2 h-2 rounded-full bg-gray-400 mr-2"></span> Offline
                    </span>
                </div>
                <span id="dataMode" class="text-[10px] text-gray-400 mt-1 italic text-right">ƒêang t·∫£i...</span>
            </div>
        </div>

        <!-- Search Area -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-6">
            <div class="relative" id="modelSearchContainer">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">1. Ch·ªçn D√≤ng M√°y</label>
                <div class="relative flex items-center shadow-sm rounded-xl bg-white border border-gray-200">
                    <input id="modelInput" type="text" placeholder="G√µ t√™n m√°y (VD: 14 Pro Max)..."
                           class="w-full p-3 sm:p-4 rounded-l-xl focus:ring-2 focus:ring-indigo-500 focus:outline-none text-gray-800 font-medium"
                           oninput="updateSuggestions(this.value, 'model')" autocomplete="off">
                    <button id="renameModelButton" onclick="openActionModal('model', 'rename')" disabled class="bg-gray-100 text-gray-500 p-3 sm:p-4 hover:bg-gray-200 transition border-l border-gray-200" title="ƒê·ªïi t√™n Model"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-9-6l9-9m-9 9l4 4m-4-4l-9 9"></path></svg></button>
                    <button id="addModelButton" onclick="openActionModal('model', 'add')" class="bg-indigo-600 text-white p-3 sm:p-4 rounded-r-xl hover:bg-indigo-700 transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></button>
                </div>
                <div id="modelSuggestions" class="suggestions-container hidden"></div>
            </div>

            <div class="relative" id="serviceSearchContainer">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">2. Ch·ªçn D·ªãch V·ª•</label>
                <div class="relative flex items-center shadow-sm rounded-xl bg-gray-100 border border-gray-200">
                    <input id="serviceInput" type="text" placeholder="G√µ d·ªãch v·ª•..." disabled
                           class="w-full p-3 sm:p-4 rounded-l-xl bg-transparent text-gray-500 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:outline-none transition font-medium"
                           oninput="updateSuggestions(this.value, 'service')" autocomplete="off">
                    <button id="renameServiceButton" onclick="openActionModal('service', 'rename')" disabled class="bg-gray-200 text-gray-400 p-3 sm:p-4 hover:bg-gray-300 transition border-l border-gray-200" title="ƒê·ªïi t√™n D·ªãch v·ª•"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-9-6l9-9m-9 9l4 4m-4-4l-9 9"></path></svg></button>
                    <button id="addServiceButton" onclick="openActionModal('service', 'add')" disabled class="bg-gray-400 text-white p-3 sm:p-4 rounded-r-xl transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></button>
                </div>
                <div id="serviceSuggestions" class="suggestions-container hidden"></div>
            </div>
        </div>

        <div id="resultDisplay" class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden min-h-[200px] relative">
            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                <h3 id="tableTitle" class="font-bold text-gray-700">Chi Ti·∫øt B√°o Gi√°</h3>
                <button onclick="addQualityLevelRow()" id="addRowBtn" class="hidden text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full font-semibold hover:bg-green-200 transition border border-green-200">+ Th√™m Lo·∫°i M·ªõi</button>
            </div>
            <div id="quoteStatus" class="p-8 text-center text-gray-400 italic">Vui l√≤ng ch·ªçn D√≤ng m√°y v√† D·ªãch v·ª• ƒë·ªÉ xem gi√°.</div>
            <div id="priceComparisonTable" class="table-container hidden"></div>
        </div>

        <div class="mt-8 flex justify-center space-x-4">
            <button onclick="openAdminModal()" class="text-indigo-600 text-sm font-medium hover:underline flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0l-4-4m4 4v12"></path></svg>
                Qu·∫£n l√Ω D·ªØ Li·ªáu (Import/Export)
            </button>
        </div>
    </div>

    <!-- MODALS -->
    <div id="quickAddModal" class="fixed inset-0 z-modal hidden flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100" id="quickAddModalContent">
            <h4 id="addModalTitle" class="text-xl font-bold mb-4 text-gray-800">Th√™m M·ªõi</h4>
            <input id="addModalInput" type="text" placeholder="Nh·∫≠p t√™n..." class="p-3 border border-gray-300 rounded-lg w-full mb-4 focus:ring-2 focus:ring-indigo-500 outline-none">
            <div class="flex justify-end gap-3">
                <button onclick="closeActionModal()" class="px-4 py-2 bg-gray-100 rounded-lg text-gray-600 font-medium hover:bg-gray-200">H·ªßy</button>
                <button onclick="handleAction()" id="confirmActionButton" class="px-4 py-2 bg-indigo-600 rounded-lg text-white font-medium hover:bg-indigo-700">X√°c Nh·∫≠n</button>
            </div>
        </div>
    </div>

    <div id="editRowModal" class="fixed inset-0 z-modal hidden flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]" id="editRowModalContent">
            <h4 class="text-xl font-bold mb-4 text-gray-800">S·ª≠a Th√¥ng Tin</h4>
            <div class="space-y-4">
                <div><label class="block text-xs text-gray-500 font-bold uppercase">T√™n Linh Ki·ªán / Lo·∫°i</label><input id="editGradeInput" type="text" class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-indigo-500"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs text-gray-500 font-bold uppercase">Gi√° (LAK)</label><input id="editPriceInput" type="text" class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-indigo-500 font-mono font-bold text-red-600 text-lg"><p class="text-[10px] text-gray-400 mt-1">T·ª± ƒë·ªông th√™m d·∫•u ph·∫©y</p></div>
                    <div>
                        <label class="block text-xs text-gray-500 font-bold uppercase">B·∫£o H√†nh</label>
                        <div class="flex gap-2 mt-1">
                            <input id="editWarrantyNum" type="number" class="w-16 p-3 border border-gray-300 rounded-lg text-center font-bold">
                            <select id="editWarrantyUnit" onchange="toggleEditWarrantyInput()" class="flex-1 p-3 border border-gray-300 rounded-lg bg-white text-sm cursor-pointer">
                                <option value="Ng√†y">Ng√†y</option><option value="Th√°ng">Th√°ng</option><option value="NƒÉm">NƒÉm</option><option value="Tr·ªçn ƒë·ªùi">Tr·ªçn ƒë·ªùi</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div><label class="block text-xs text-gray-500 font-bold uppercase">Ghi Ch√∫ Chi Ti·∫øt</label><textarea id="editNotesInput" rows="3" class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-indigo-500"></textarea></div>
            </div>
            <div class="flex justify-end mt-6 pt-4 border-t border-gray-100 gap-3">
                <button onclick="closeEditModal()" class="px-4 py-2 bg-gray-100 rounded-lg text-gray-600 font-medium hover:bg-gray-200">H·ªßy</button>
                <button onclick="saveRowEdit()" id="saveRowBtn" class="px-4 py-2 bg-indigo-600 rounded-lg text-white font-medium hover:bg-indigo-700 shadow">L∆∞u Thay ƒê·ªïi</button>
            </div>
        </div>
    </div>

    <div id="deleteConfirmModal" class="fixed inset-0 z-modal-top hidden flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl">
            <h4 class="font-bold text-gray-800 text-lg" id="deleteTitle">X√≥a D√≤ng N√†y?</h4>
            <p class="text-gray-500 text-sm mt-2 mb-6">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a <span id="deleteItemName" class="font-bold text-gray-800">m·ª•c n√†y</span>?</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteConfirmModal()" class="flex-1 py-2 bg-gray-100 rounded-lg font-medium hover:bg-gray-200">H·ªßy</button>
                <button onclick="executeDeleteAction()" class="flex-1 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 shadow">X√≥a Ngay</button>
            </div>
        </div>
    </div>

    <!-- All Services Modal (With Delete) -->
    <div id="allServicesModal" class="fixed inset-0 z-modal hidden flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6 transform transition-all duration-300 scale-95 opacity-0 flex flex-col max-h-[90vh]" id="allServicesModalContent">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h4 id="allServicesTitle" class="text-2xl font-bold text-gray-800">Ch·ªçn D·ªãch V·ª•</h4>
                <button onclick="closeAllServicesModal()" class="text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <p class="text-xs text-gray-500 mb-2 italic">B·∫•m v√†o t√™n ƒë·ªÉ ch·ªçn, b·∫•m v√†o th√πng r√°c ƒë·ªè ƒë·ªÉ x√≥a vƒ©nh vi·ªÖn (To√†n h·ªá th·ªëng)</p>
            <div id="allServicesGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 overflow-y-auto p-2"></div>
            <div class="mt-4 pt-2 border-t text-right">
                <button onclick="closeAllServicesModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition hover:bg-gray-400">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Admin/Import Modal -->
    <div id="dataManagementModal" class="fixed inset-0 z-modal hidden flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <h4 class="text-xl font-bold mb-4">Qu·∫£n L√Ω D·ªØ Li·ªáu</h4>
            <div class="space-y-3">
                <div class="border-t pt-3">
                    <p class="text-sm text-gray-500 mb-2">Nh·∫≠p/Xu·∫•t File Excel (CSV)</p>
                    <div class="mb-3 p-3 bg-gray-50 rounded-lg border border-dashed border-gray-300 text-center">
                        <label for="csvFileInput" class="cursor-pointer">
                            <span class="block text-indigo-600 font-bold text-sm mb-1 hover:underline">üìÇ B·∫•m v√†o ƒë√¢y ƒë·ªÉ t·∫£i file CSV l√™n</span>
                            <span class="block text-xs text-gray-400">H·ªó tr·ª£ ƒë·ªãnh d·∫°ng .csv</span>
                        </label>
                        <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="handleFileUpload(this)">
                    </div>
                    <textarea id="importTextarea" rows="4" class="w-full p-3 border border-gray-300 rounded-lg font-mono text-xs" placeholder="D·ªØ li·ªáu CSV s·∫Ω hi·ªán ·ªü ƒë√¢y khi t·∫£i file..."></textarea>
                    <div class="flex gap-3 mt-2">
                        <button onclick="exportCSVData()" class="flex-1 py-2 bg-green-600 text-white rounded-lg font-bold shadow hover:bg-green-700 text-sm">T·∫£i Xu·ªëng Excel</button>
                        <button onclick="importCSVData()" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-indigo-700 text-sm">Nh·∫≠p D·ªØ Li·ªáu</button>
                    </div>
                </div>
            </div>
            <button onclick="closeAdminModal()" class="mt-4 w-full py-2 text-gray-400 text-sm hover:text-gray-600">ƒê√≥ng</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg text-sm font-medium transition-opacity opacity-0 pointer-events-none z-50 whitespace-nowrap">Th√¥ng b√°o</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        window.fbModules = { initializeApp, getAuth, signInAnonymously, getFirestore, doc, setDoc, onSnapshot, runTransaction };
        if (localStorage.getItem('my_firebase_config')) window.initAppWithConfig();
        else document.getElementById('setupScreen').classList.remove('hidden');
    </script>

    <script>
        function setupEventListeners() {
            const sInput = document.getElementById('serviceInput');
            const mInput = document.getElementById('modelInput');
            mInput.addEventListener('keydown', handleKeyNavigation);
            sInput.addEventListener('keydown', handleKeyNavigation);
            sInput.addEventListener('focus', () => window.updateSuggestions(sInput.value, 'service'));
            sInput.addEventListener('mouseenter', () => { if(!sInput.disabled) window.updateSuggestions(sInput.value, 'service'); });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#modelSearchContainer')) document.getElementById('modelSuggestions').classList.add('hidden');
                if (!e.target.closest('#serviceSearchContainer')) document.getElementById('serviceSuggestions').classList.add('hidden');
            });
        }

        let priceStructure = {}, allModels = [], allServices = [];
        let currentModel = '', currentEditingQuality = '', itemToDelete = '', deleteMode = '';
        let db = null, auth = null, isOnline = false, activeSuggestionIndex = -1;
        let currentActionType = {};
        const COLLECTION_PATH = 'store_data', DOC_ID = 'pricing_master'; 
        let isResetting = false; 
        let dragSrcRow = null;

        const sanitizeKey = (key) => key.trim().replace(/[./#\[\]\\]/g, "_");

        const generateDefaultData = () => {
            let data = {};
            const iphones=["iPhone 6","iPhone 6 Plus","iPhone 6s","iPhone 6s Plus","iPhone 7","iPhone 7 Plus","iPhone 8","iPhone 8 Plus","iPhone X","iPhone XR","iPhone XS","iPhone XS Max","iPhone 11","iPhone 11 Pro","iPhone 11 Pro Max","iPhone 12","iPhone 12 Mini","iPhone 12 Pro","iPhone 12 Pro Max","iPhone 13","iPhone 13 Mini","iPhone 13 Pro","iPhone 13 Pro Max","iPhone 14","iPhone 14 Plus","iPhone 14 Pro","iPhone 14 Pro Max","iPhone 15","iPhone 15 Plus","iPhone 15 Pro","iPhone 15 Pro Max","iPhone 16","iPhone 16 Plus","iPhone 16 Pro","iPhone 16 Pro Max","iPhone 17","iPhone 17 Plus","iPhone 17 Pro","iPhone 17 Pro Max"];
            const samsungS=["Samsung S8","Samsung S8+","Samsung S9","Samsung S9+","Samsung S10","Samsung S10+","Samsung S10e","Samsung S20","Samsung S20+","Samsung S20 Ultra","Samsung S20 FE","Samsung S21","Samsung S21+","Samsung S21 Ultra","Samsung S21 FE","Samsung S22","Samsung S22+","Samsung S22 Ultra","Samsung S23","Samsung S23+","Samsung S23 Ultra","Samsung S23 FE","Samsung S24","Samsung S24+","Samsung S24 Ultra","Samsung S25","Samsung S25+","Samsung S25 Ultra"];
            const samsungNote=["Samsung Note 8","Samsung Note 9","Samsung Note 10","Samsung Note 10+","Samsung Note 10 Lite","Samsung Note 20","Samsung Note 20 Ultra"];
            const samsungA=["Samsung A05","Samsung A05s","Samsung A15","Samsung A25","Samsung A35","Samsung A55","Samsung A04","Samsung A04s","Samsung A14","Samsung A24","Samsung A34","Samsung A54","Samsung A03","Samsung A13","Samsung A23","Samsung A33","Samsung A53","Samsung A73","Samsung A12","Samsung A22","Samsung A32","Samsung A52","Samsung A52s","Samsung A72"];
            const oppo=["OPPO Find N3","OPPO Find N3 Flip","OPPO Find N2 Flip","OPPO Reno11 F","OPPO Reno11","OPPO Reno11 Pro","OPPO Reno10","OPPO Reno10 Pro","OPPO Reno10 Pro+","OPPO Reno8 T","OPPO Reno8 Z","OPPO Reno8","OPPO A79","OPPO A58","OPPO A38","OPPO A18","OPPO A98","OPPO A78","OPPO A77s","OPPO A57","OPPO A17","OPPO A17k"];
            const vivo=["Vivo X100","Vivo X100 Pro","Vivo X90","Vivo X80","Vivo V30","Vivo V30e","Vivo V29","Vivo V29e","Vivo V27","Vivo V27e","Vivo Y100","Vivo Y36","Vivo Y27","Vivo Y17s","Vivo Y03","Vivo Y02t"];
            const xiaomi=["Xiaomi 14","Xiaomi 14 Ultra","Xiaomi 13","Xiaomi 13T","Xiaomi 13T Pro","Xiaomi 12","Xiaomi 12T","Redmi Note 13","Redmi Note 13 Pro","Redmi Note 13 Pro+","Redmi Note 12","Redmi Note 12 Pro","Redmi Note 12s","Redmi 13C","Redmi 12","Redmi A3"];
            const realme=["Realme GT5 Pro","Realme 11 Pro","Realme 11 Pro+","Realme 11","Realme C67","Realme C65","Realme C55","Realme C53","Realme C51","Realme Note 50"];
            const others=["Huawei P60 Pro","Huawei Mate 60","Huawei P50","Honor X9b","Honor 90","Honor X8b","Honor X7b","Infinix Note 40 Pro","Infinix Note 30","Infinix Hot 40","Infinix Hot 30","Infinix Smart 8","Tecno Camon 30","Tecno Pova 6","Tecno Spark 20","Tecno Spark 20 Pro","Tecno Spark 10"];
            const services=["Back Glass (K√≠nh l∆∞ng) ‡∫ù‡∫≤‡∫´‡∫•‡∫±‡∫á","Battery (Pin) ‡ªÅ‡∫ö‡∫±‡∫î‡ªÄ‡∫ï‡∫µ‡∫•‡∫µ","Memory upgrade(N√¢ng c·∫•p b·ªô nh·ªõ) ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫Ñ‡∫ß‡∫≤‡∫°‡∫à‡∫≥","Charging Port (Ch√¢n s·∫°c)‡∫Å‡∫ª‡∫ô‡∫™‡∫≤‡∫Å","Face ID ‡∫™‡∫∞‡ªÅ‡∫Å‡∫ô‡ªú‡ªâ‡∫≤","Front Camera ( Camera tr∆∞·ªõc) ‡∫Å‡ªâ‡∫≠‡∫á‡ªú‡ªâ‡∫≤","Glass Screen (K√≠nh m√†n h√¨nh) ‡∫•‡∫≠‡∫Å‡ªÅ‡∫Å‡ªâ‡∫ß‡∫à‡ªç","Power Flex (C√°p ngu·ªìn) ‡∫™‡∫≤‡∫ç‡ªÄ‡∫õ‡∫µ‡∫î-‡∫õ‡∫¥‡∫î","Rear Camera (Camera sau) ‡∫Å‡ªâ‡∫≠‡∫á‡∫´‡∫•‡∫±‡∫á","Screen (M√†n h√¨nh) ‡∫õ‡ªà‡∫Ω‡∫ô‡∫à‡ªç","Speaker (Loa) ‡∫•‡∫≥‡ªÇ‡∫û‡∫á","Volume Flex (C√°p √¢m l∆∞·ª£ng) ‡∫™‡∫≤‡∫ç‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫™‡∫Ω‡∫á-‡∫•‡∫ª‡∫î‡∫™‡∫Ω‡∫á","Bypass + FRP ‡∫ö‡∫≤‡∫ç‡∫û‡∫≤‡∫™","Body (v·ªè) ‡∫ö‡ªç‡∫î‡∫µ‡ªâ","Microphone ‡ªÑ‡∫°","SIM tray (Khay sim) ‡ªÅ‡∫ú‡ªà‡∫ô‡∫Æ‡∫≠‡∫á‡∫ä‡∫¥‡∫°","Button (Ph√≠m b·∫•m) ‡∫õ‡∫∏‡ªà‡∫°","IC Audio ‡ªÑ‡∫≠‡∫ä‡∫µ‡∫™‡∫Ω‡∫á","IC Power ‡ªÑ‡∫≠‡∫ä‡∫µ‡∫û‡∫≤‡∫ß‡ªÄ‡∫ß‡∫µ‡ªâ","IC Charging ‡ªÑ‡∫≠‡∫ä‡∫µ‡∫™‡∫≤‡∫Å","IC Wifi ‡ªÑ‡∫≠‡∫ä‡∫µ‡ªÑ‡∫ß‡∫ü‡∫≤‡∫ç","Camera Glass (M·∫∑t k√≠nh camera) ‡ªÅ‡∫Å‡ªâ‡∫ß‡∫Å‡ªâ‡∫≠‡∫á","Mainboard (Bo m·∫°ch) ‡ªÄ‡∫°‡∫ô‡∫ö‡∫≠‡∫î","Display Cable (C√°p m√†n h√¨nh) ‡∫™‡∫≤‡∫ç‡ªÅ‡∫û‡∫à‡ªç","Motherboard flex cable (C√°p n·ªëi bo m·∫°ch)","Flashlight (ƒê√®n pin) ‡ªÑ‡∫ü‡∫™‡∫≤‡∫ç","Sensor Cable ( C√°p c·∫£m bi·∫øn) ‡∫™‡∫≤‡∫ç‡ªÅ‡∫û‡ªÄ‡∫ä‡∫±‡∫ô‡ªÄ‡∫ä‡∫µ‡ªâ","Network error (L·ªói m·∫°ng) ‡∫™‡∫±‡∫ô‡∫ç‡∫≤‡∫ô‡∫≠‡∫¥‡∫ô‡ªÄ‡∫ï‡∫µ‡ªÄ‡∫ô‡∫±‡∫î","Phone cleaning service (D·ªãch v·ª• v·ªá sinh ƒëi·ªán tho·∫°i) ‡∫•‡ªâ‡∫≤‡∫á‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫á","Mainboard Repair ‡ªÅ‡∫õ‡∫á‡ªÄ‡∫°‡∫ô‡∫ö‡∫≠‡∫î"];
            
            [...iphones,...samsungS,...samsungNote,...samsungA,...oppo,...vivo,...xiaomi,...realme,...others].forEach(m=>{
                data[m]={};
                services.forEach(s=>{ 
                    data[m][s]={ "Standard Grade":{price:0,warranty:"6 Th√°ng",notes:"Ch∆∞a c√≥ th√¥ng tin", order: 1} }; 
                });
            });
            return data;
        };

        const performTransaction = async (manipulateFn) => {
            priceStructure = manipulateFn(JSON.parse(JSON.stringify(priceStructure)));
            localStorage.setItem('local_pricing_data_v8', JSON.stringify(priceStructure));
            refreshDataLists(); 
            
            if(isOnline && db) {
                const { doc, runTransaction } = window.fbModules;
                const docRef = doc(db, COLLECTION_PATH, DOC_ID);
                document.getElementById('dataMode').innerText = "ƒêang ƒë·ªìng b·ªô...";
                try {
                    await runTransaction(db, async (transaction) => {
                        const sfDoc = await transaction.get(docRef);
                        if (!sfDoc.exists()) throw "Doc missing";
                        let remoteData = sfDoc.data().data || {};
                        remoteData = manipulateFn(remoteData);
                        transaction.update(docRef, { data: remoteData });
                    });
                    document.getElementById('dataMode').innerText = "ƒê√£ ƒë·ªìng b·ªô";
                } catch (e) { console.error(e); showToast("L·ªói ƒë·ªìng b·ªô: " + e.message, false); }
            } else { showToast("ƒê√£ l∆∞u Offline"); }
        };

        window.saveRowEdit = async () => {
            const svc = document.getElementById('serviceInput').value;
            const name = document.getElementById('editGradeInput').value.trim();
            const price = parseInt(document.getElementById('editPriceInput').value.replace(/,/g,'')) || 0;
            const notes = document.getElementById('editNotesInput').value.trim();
            const warranty = document.getElementById('editWarrantyNum').value + ' ' + document.getElementById('editWarrantyUnit').value;
            const btn = document.getElementById('saveRowBtn');
            btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true;
            await performTransaction((data) => {
                if(!data[currentModel]) data[currentModel] = {};
                if(!data[currentModel][svc]) data[currentModel][svc] = {};
                const oldOrder = (data[currentModel][svc][currentEditingQuality] || {}).order || 9999;
                if(name !== currentEditingQuality) delete data[currentModel][svc][currentEditingQuality];
                data[currentModel][svc][name] = { price, warranty, notes, order: oldOrder };
                return data;
            });
            btn.innerText = "L∆∞u Thay ƒê·ªïi"; btn.disabled = false; closeEditModal();
        };

        window.handleAction = async () => {
            let val = document.getElementById('addModalInput').value.trim();
            if(!val) return showToast("Vui l√≤ng nh·∫≠p t√™n!", false);
            val = sanitizeKey(val);
            const { type, action } = currentActionType;
            const targetModel = currentModel;
            const targetSvc = document.getElementById('serviceInput').value;

            await performTransaction((data) => {
                if(action === 'add') {
                    if(type === 'model') {
                        if(data[val]) return data; 
                        data[val] = {};
                        const def = generateDefaultData();
                        const sampleModel = Object.keys(def)[0];
                        Object.keys(def[sampleModel]).forEach(s => { data[val][s] = { "Standard Grade": { price: 0, warranty: "6 Th√°ng", notes: "", order: 1 } }; });
                    } else {
                        if(!data[targetModel]) data[targetModel] = {}; 
                        if(!data[targetModel][val]) data[targetModel][val] = { "Standard Grade": { price: 0, warranty: "6 Th√°ng", notes: "", order: 1 } };
                    }
                } else {
                    if (type === 'model') {
                        if(data[targetModel]) { data[val] = data[targetModel]; delete data[targetModel]; }
                    } else {
                        if(data[targetModel] && data[targetModel][targetSvc]) { data[targetModel][val] = data[targetModel][targetSvc]; delete data[targetModel][targetSvc]; }
                    }
                }
                return data;
            });

            if (action === 'rename' && type === 'model') currentModel = val;
            closeActionModal();
            
            if (type === 'model') { document.getElementById('modelInput').value = val; window.selectItem(val, 'model'); } 
            else { document.getElementById('serviceInput').value = val; window.selectItem(val, 'service'); }
        };

        window.executeDeleteAction = async () => {
            const targetModel = currentModel;
            const targetSvc = document.getElementById('serviceInput').value;
            const targetItem = itemToDelete;
            const mode = deleteMode;

            await performTransaction((data) => {
                if(mode === 'GLOBAL_SERVICE') {
                    Object.keys(data).forEach(m => { if(data[m][targetItem]) delete data[m][targetItem]; });
                } else if (mode === 'ROW') {
                    if(data[targetModel] && data[targetModel][targetSvc]) delete data[targetModel][targetSvc][targetItem];
                }
                return data;
            });
            
            if(mode === 'GLOBAL_SERVICE') {
                allServices = allServices.filter(s => s !== targetItem);
                if(!document.getElementById('allServicesModal').classList.contains('hidden')) window.showAllServices();
            } else {
                displayPriceTable();
            }
            closeDeleteConfirmModal();
        };

        window.addQualityLevelRow = async () => {
            const svc = document.getElementById('serviceInput').value;
            if (!currentModel || !priceStructure[currentModel] || !priceStructure[currentModel][svc]) return showToast("Vui l√≤ng ch·ªçn d·ªãch v·ª•!", false);
            showToast("ƒêang t·∫°o d√≤ng m·ªõi...");
            await performTransaction((data) => {
                let newName = "Linh ki·ªán m·ªõi"; let count = 1;
                while(data[currentModel][svc][newName]) newName = `Linh ki·ªán m·ªõi ${count++}`;
                data[currentModel][svc][newName] = { price: 0, warranty: "3 Th√°ng", notes: "", order: 99999 };
                return data;
            });
        };

        window.saveNewOrder = async () => {
            const rows = document.querySelectorAll('#priceComparisonTable tbody tr');
            const svc = document.getElementById('serviceInput').value;
            const newOrderMap = {};
            rows.forEach((row, index) => { const key = row.getAttribute('data-key'); if (key) newOrderMap[key] = index; });
            await performTransaction((data) => {
                if(data[currentModel] && data[currentModel][svc]) {
                    Object.keys(data[currentModel][svc]).forEach(k => { if(newOrderMap[k] !== undefined) data[currentModel][svc][k].order = newOrderMap[k]; });
                }
                return data;
            });
        };

        window.hardResetApp = () => {
            if(confirm("X√ìA d·ªØ li·ªáu l·ªói tr√™n m√°y n√†y v√† t·∫£i l·∫°i b·∫£n chu·∫©n t·ª´ Cloud?")) {
                localStorage.removeItem('local_pricing_data_v8'); window.location.reload();
            }
        };

        window.saveConfiguration = () => {
            let input = document.getElementById('firebaseConfigInput').value.trim();
            if (input.startsWith("const firebaseConfig =")) input = input.replace("const firebaseConfig =", "").trim();
            if (input.endsWith(";")) input = input.slice(0, -1).trim();
            try {
                const config = new Function("return " + input)();
                if (!config.apiKey) throw new Error("Invalid Config");
                localStorage.setItem('my_firebase_config', JSON.stringify(config));
                localStorage.removeItem('offline_mode'); 
                document.getElementById('setupScreen').classList.add('hidden');
                window.location.reload(); 
            } catch (e) { alert("M√£ c·∫•u h√¨nh kh√¥ng h·ª£p l·ªá!"); }
        };

        window.useOfflineMode = () => { localStorage.setItem('offline_mode', 'true'); document.getElementById('setupScreen').classList.add('hidden'); initOffline(); };
        window.resetConfig = () => { if(confirm("ƒêƒÉng xu·∫•t?")) { localStorage.removeItem('my_firebase_config'); localStorage.removeItem('offline_mode'); window.location.reload(); } };

        window.initAppWithConfig = async () => {
            const configStr = localStorage.getItem('my_firebase_config');
            if (localStorage.getItem('offline_mode')) { initOffline(); return; } 
            if (!configStr) return;
            try {
                const config = JSON.parse(configStr);
                if(config.apiKey) document.getElementById('configIdDisplay').innerText = "ID: " + config.apiKey.substring(0, 5) + "...";
                const { initializeApp, getAuth, signInAnonymously, getFirestore, doc, onSnapshot } = window.fbModules;
                const app = initializeApp(config); const auth = getAuth(app); db = getFirestore(app);
                updateSyncStatus('connecting');
                try { await signInAnonymously(auth); } catch(e) { console.error("Auth", e); }
                onSnapshot(doc(db, COLLECTION_PATH, DOC_ID), (docSnap) => {
                    if (isResetting) return; 
                    if (docSnap.metadata.hasPendingWrites) return;
                    if (docSnap.exists()) {
                        const cloudData = docSnap.data().data || {};
                        if (!cloudData || Object.keys(cloudData).length === 0) {
                             const local = localStorage.getItem('local_pricing_data_v8');
                             if(local && local.length > 5000) {
                                 priceStructure = JSON.parse(local);
                                 const { doc, setDoc } = window.fbModules;
                                 setDoc(doc(db, COLLECTION_PATH, DOC_ID), { data: priceStructure });
                             } else { priceStructure = generateDefaultData(); }
                        } else { priceStructure = mergeWithDefaults(cloudData); }
                        localStorage.setItem('local_pricing_data_v8', JSON.stringify(priceStructure));
                        updateSyncStatus('online'); refreshDataLists();
                        const table = document.getElementById('priceComparisonTable');
                        if(!table.classList.contains('hidden')) {
                            const rows = table.querySelectorAll('tr'); rows.forEach(r => r.classList.add('updated-row'));
                            setTimeout(() => rows.forEach(r => r.classList.remove('updated-row')), 1500);
                        }
                    } else {
                        priceStructure = generateDefaultData();
                        const { doc, setDoc } = window.fbModules;
                        setDoc(doc(db, COLLECTION_PATH, DOC_ID), { data: priceStructure });
                        refreshDataLists();
                    }
                }, (err) => { updateSyncStatus('error'); initOffline(); });
                isOnline = true;
            } catch (e) { updateSyncStatus('error'); initOffline(); }
            setupEventListeners();
        };

        const initOffline = () => {
            const local = localStorage.getItem('local_pricing_data_v8');
            priceStructure = local ? JSON.parse(local) : {};
            priceStructure = mergeWithDefaults(priceStructure);
            refreshDataLists();
            updateSyncStatus('offline');
            setupEventListeners();
        };

        const mergeWithDefaults = (loadedData) => {
            const defaults = generateDefaultData();
            if (!loadedData) return defaults;
            const merged = JSON.parse(JSON.stringify(loadedData));
            Object.keys(defaults).forEach(m => {
                if (!merged[m]) merged[m] = JSON.parse(JSON.stringify(defaults[m]));
            });
            return merged;
        };

        const refreshDataLists = () => {
            if (!priceStructure) return;
            allModels = Object.keys(priceStructure).sort();
            const svcSet = new Set();
            Object.values(priceStructure).forEach(m => { if(m) Object.keys(m).forEach(s => svcSet.add(s)); });
            allServices = Array.from(svcSet).sort();
            if (currentModel && document.getElementById('serviceInput').value) displayPriceTable();
        };

        window.displayPriceTable = () => {
            const svc = document.getElementById('serviceInput').value;
            if (!currentModel || !priceStructure[currentModel] || !priceStructure[currentModel][svc]) return toggleTable(false);
            const data = priceStructure[currentModel][svc];
            let entries = Object.entries(data);
            entries.sort((a, b) => {
                const orderA = (a[1].order !== undefined) ? a[1].order : 9999;
                const orderB = (b[1].order !== undefined) ? b[1].order : 9999;
                if (orderA !== orderB) return orderA - orderB;
                return a[0].localeCompare(b[0]);
            });
            let html = `<table class="price-table w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b"><tr><th class="w-10 px-2 py-3"></th><th class="px-4 py-3 w-1/4">Lo·∫°i Linh Ki·ªán</th><th class="px-4 py-3 w-1/3">Ghi Ch√∫</th><th class="px-4 py-3 text-right">Gi√° (LAK)</th><th class="px-4 py-3 text-center">B·∫£o H√†nh</th><th class="px-4 py-3 text-center">S·ª≠a</th></tr></thead><tbody ondragover="handleDragOver(event)" ondrop="handleDrop(event)">`;
            entries.forEach(([k, d]) => {
                const safeKey = k.replace(/"/g, '&quot;');
                html += `<tr class="draggable-row border-b hover:bg-indigo-50 transition-colors" draggable="true" data-key="${safeKey}" ondragstart="handleDragStart(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)" ondragend="handleDragEnd(event)"><td class="px-2 py-3 text-center"><div class="drag-handle" title="K√©o ƒë·ªÉ s·∫Øp x·∫øp"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></div></td><td class="px-4 py-3 font-bold text-gray-800">${k}</td><td class="px-4 py-3 text-xs text-gray-500">${d.notes}</td><td class="px-4 py-3 text-right font-bold text-red-600">${formatMoney(d.price)}</td><td class="px-4 py-3 text-center text-xs bg-green-50 text-green-700 rounded font-semibold">${d.warranty}</td><td class="px-4 py-3 text-center flex justify-center gap-2"><button onclick="openEditModal('${safeKey.replace(/'/g, "\\'")}')" class="text-indigo-600 p-2 hover:bg-indigo-100 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button><button onclick="openDeleteConfirmModal('${safeKey.replace(/'/g, "\\'")}')" class="text-red-500 p-2 hover:bg-red-100 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></td></tr>`;
            });
            document.getElementById('priceComparisonTable').innerHTML = html + '</tbody></table>';
            document.getElementById('tableTitle').innerText = `${currentModel} - ${svc}`;
            toggleTable(true);
        };

        // --- HANDLERS (Drag, Modal, Admin) ---
        window.handleDragStart = (e) => { dragSrcRow = e.target.closest('tr'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', dragSrcRow.innerHTML); setTimeout(() => dragSrcRow.classList.add('dragging'), 0); };
        window.handleDragOver = (e) => { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; };
        window.handleDragEnter = (e) => { const row = e.target.closest('tr'); if (row && row !== dragSrcRow) row.classList.add('drag-over'); };
        window.handleDragLeave = (e) => { const row = e.target.closest('tr'); if (row) row.classList.remove('drag-over'); };
        window.handleDrop = (e) => { if (e.stopPropagation) e.stopPropagation(); const dropRow = e.target.closest('tr'); if (dragSrcRow && dropRow && dragSrcRow !== dropRow) { const tbody = dropRow.parentNode; const rows = Array.from(tbody.querySelectorAll('tr')); const srcIndex = rows.indexOf(dragSrcRow); const targetIndex = rows.indexOf(dropRow); if (srcIndex < targetIndex) dropRow.after(dragSrcRow); else dropRow.before(dragSrcRow); saveNewOrder(); } return false; };
        window.handleDragEnd = (e) => { const rows = document.querySelectorAll('#priceComparisonTable tbody tr'); rows.forEach(r => { r.classList.remove('drag-over'); r.classList.remove('dragging'); }); };

        window.openEditModal = (k) => { 
            const svc = document.getElementById('serviceInput').value;
            if (!priceStructure[currentModel] || !priceStructure[currentModel][svc]) return showToast("D·ªØ li·ªáu kh√¥ng ƒë·ªìng b·ªô, t·∫£i l·∫°i trang", false);
            const d = priceStructure[currentModel][svc][k]; 
            if (!d) { showToast("D√≤ng n√†y kh√¥ng c√≤n t·ªìn t·∫°i.", false); displayPriceTable(); return; }
            currentEditingQuality = k; 
            document.getElementById('editGradeInput').value = k; 
            document.getElementById('editPriceInput').value = d.price.toLocaleString('en-US'); 
            document.getElementById('editNotesInput').value = d.notes || ""; 
            const wVal = d.warranty || ""; const wParts = wVal.split(' ');
            if(wParts.length >= 2) { document.getElementById('editWarrantyNum').value = wParts[0]; document.getElementById('editWarrantyUnit').value = wParts.slice(1).join(' '); } 
            else { document.getElementById('editWarrantyNum').value = "6"; document.getElementById('editWarrantyUnit').value = "Th√°ng"; }
            document.getElementById('editRowModal').classList.remove('hidden'); 
        };
        window.closeEditModal = () => document.getElementById('editRowModal').classList.add('hidden');
        window.openDeleteConfirmModal = (k) => { itemToDelete = k; deleteMode = 'ROW'; document.getElementById('deleteTitle').innerText = "X√≥a D√≤ng N√†y?"; document.getElementById('deleteItemName').innerText = k; document.getElementById('deleteConfirmModal').classList.remove('hidden'); };
        window.closeDeleteConfirmModal = () => document.getElementById('deleteConfirmModal').classList.add('hidden');
        window.openActionModal = (t, a) => { currentActionType = { type:t, action:a }; document.getElementById('addModalTitle').innerText = t==='model'?"Th√™m D√≤ng M√°y":"Th√™m D·ªãch V·ª•"; document.getElementById('quickAddModal').classList.remove('hidden'); document.getElementById('addModalInput').value = document.getElementById(t + 'Input').value; setTimeout(() => document.getElementById('addModalInput').focus(), 50); };
        window.closeActionModal = () => document.getElementById('quickAddModal').classList.add('hidden');

        // Admin Helpers
        window.openAdminModal = () => document.getElementById('dataManagementModal').classList.remove('hidden');
        window.closeAdminModal = () => document.getElementById('dataManagementModal').classList.add('hidden');
        
        window.confirmDeleteGlobalService = (s) => { itemToDelete = s; deleteMode = 'GLOBAL_SERVICE'; document.getElementById('deleteTitle').innerText = "X√≥a D·ªãch V·ª• To√†n H·ªá Th·ªëng?"; document.getElementById('deleteItemName').innerText = s; document.getElementById('deleteConfirmModal').classList.remove('hidden'); };
        window.exportCSVData = () => { let csvContent = "\uFEFFModel,D·ªãch V·ª•,Lo·∫°i Linh Ki·ªán,Gi√°,B·∫£o H√†nh,Ghi Ch√∫\n"; Object.keys(priceStructure).forEach(model => { Object.keys(priceStructure[model]).forEach(service => { Object.keys(priceStructure[model][service]).forEach(quality => { const item = priceStructure[model][service][quality]; csvContent += `"${model.replace(/"/g, '""')}","${service.replace(/"/g, '""')}","${quality.replace(/"/g, '""')}",${item.price},"${item.warranty}","${item.notes}"\n`; }); }); }); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.setAttribute("href", url); link.setAttribute("download", `bao_gia.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
        
        window.handleFileUpload = (input) => {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('importTextarea').value = e.target.result;
                showToast("ƒê√£ t·∫£i n·ªôi dung file. B·∫•m 'Nh·∫≠p D·ªØ Li·ªáu' ƒë·ªÉ l∆∞u.");
            };
            reader.readAsText(file);
        };

        window.importCSVData = async () => {
            const rawText = document.getElementById('importTextarea').value.trim();
            if (!rawText) return showToast("Vui l√≤ng d√°n d·ªØ li·ªáu ho·∫∑c t·∫£i file CSV!", false);

            // Auto-detect delimiter
            const firstLine = rawText.split('\n')[0];
            const delimiter = firstLine.includes(';') ? ';' : ',';

            const rows = rawText.split("\n");
            let importedCount = 0;
            let temp = JSON.parse(JSON.stringify(priceStructure)); 

            // CSV Parser
            const parseCSVLine = (text) => {
                const result = [];
                let cur = '';
                let inQuote = false;
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    if (char === '"') { inQuote = !inQuote; } 
                    else if (char === delimiter && !inQuote) { result.push(cur); cur = ''; } 
                    else { cur += char; }
                }
                result.push(cur);
                return result.map(c => c.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
            };

            for (let i = 1; i < rows.length; i++) {
                if (!rows[i].trim()) continue;
                const cols = parseCSVLine(rows[i]);
                if (cols.length >= 4) {
                    const model = sanitizeKey(cols[0]);
                    const service = sanitizeKey(cols[1]);
                    const quality = cols[2];
                    const price = parseInt(cols[3].replace(/\D/g, '')) || 0;
                    const warranty = cols[4] || "Kh√¥ng b·∫£o h√†nh";
                    const notes = cols[5] || "";

                    if (model && service && quality) {
                        if (!temp[model]) temp[model] = {};
                        if (!temp[model][service]) temp[model][service] = {};
                        const existing = temp[model][service][quality];
                        temp[model][service][quality] = { price, warranty, notes, order: existing ? existing.order : 9999 };
                        importedCount++;
                    }
                }
            }

            if (importedCount > 0) {
                if(confirm(`T√¨m th·∫•y ${importedCount} m·ª•c h·ª£p l·ªá. B·∫°n c√≥ mu·ªën nh·∫≠p v√†o h·ªá th·ªëng kh√¥ng?`)) {
                    // Update Local
                    priceStructure = temp;
                    localStorage.setItem('local_pricing_data_v8', JSON.stringify(priceStructure));
                    refreshDataLists();
                    
                    // Update Cloud
                    if (isOnline && db) {
                        try {
                            const { doc, setDoc } = window.fbModules;
                            document.getElementById('dataMode').innerText = "ƒêang nh·∫≠p...";
                            await setDoc(doc(db, COLLECTION_PATH, DOC_ID), { data: temp }, { merge: true });
                            document.getElementById('dataMode').innerText = "ƒê√£ ƒë·ªìng b·ªô";
                            showToast(`ƒê√£ nh·∫≠p th√†nh c√¥ng ${importedCount} d√≤ng!`);
                        } catch(e) { console.error(e); showToast("L·ªói l∆∞u Cloud: " + e.message, false); }
                    } else { showToast(`ƒê√£ nh·∫≠p Offline ${importedCount} d√≤ng!`); }
                    closeAdminModal();
                    document.getElementById('importTextarea').value = '';
                    document.getElementById('csvFileInput').value = '';
                }
            } else { showToast("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá trong file!", false); }
        };

        const updateSyncStatus = (status) => { const el = document.getElementById('syncStatus'); const txt = document.getElementById('dataMode'); if (status === 'online') { el.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></span> Online'; txt.innerText="ƒê√£ ƒë·ªìng b·ªô"; } else if (status === 'error') { el.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500 mr-2"></span> L·ªói'; } else if (status === 'connecting') { el.innerHTML = '<span class="w-2 h-2 rounded-full bg-yellow-500 mr-2 animate-spin"></span> Connecting...'; } else { el.innerHTML = '<span class="w-2 h-2 rounded-full bg-gray-400 mr-2"></span> Offline'; } };
        const showToast = (msg, isSuccess = true) => { const t = document.getElementById('toast'); t.innerText = msg; t.className = `fixed bottom-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-lg text-sm font-medium transition-opacity opacity-0 pointer-events-none z-50 whitespace-nowrap ${isSuccess ? 'bg-gray-800 text-white' : 'bg-red-600 text-white'}`; t.style.opacity='1'; t.style.transform='translate(-50%,0)'; setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translate(-50%,20px)'; }, 2000); };
        const formatMoney = (n) => (n||0).toLocaleString('en-US') + ' LAK';
        const toggleTable = (show) => { document.getElementById('resultDisplay').classList.toggle('hidden', !show); document.getElementById('quoteStatus').classList.toggle('hidden', show); document.getElementById('priceComparisonTable').classList.toggle('hidden', !show); document.getElementById('addRowBtn').classList.toggle('hidden', !show); };
        
        const handleKeyNavigation = (e) => { const isModel = e.target.id === 'modelInput'; const container = isModel ? document.getElementById('modelSuggestions') : document.getElementById('serviceSuggestions'); const items = container.querySelectorAll('.suggestion-item'); if (container.classList.contains('hidden') || !items.length) return; if (e.key === 'ArrowDown') { e.preventDefault(); activeSuggestionIndex = (activeSuggestionIndex + 1) % items.length; updateActiveHighlight(items); } else if (e.key === 'ArrowUp') { e.preventDefault(); activeSuggestionIndex = (activeSuggestionIndex - 1 + items.length) % items.length; updateActiveHighlight(items); } else if (e.key === 'Enter') { e.preventDefault(); if(activeSuggestionIndex > -1) items[activeSuggestionIndex].click(); } else if (e.key === 'Escape') { container.classList.add('hidden'); activeSuggestionIndex = -1; } };
        const updateActiveHighlight = (items) => { items.forEach((it, i) => { if(i===activeSuggestionIndex) { it.classList.add('active-suggestion'); it.scrollIntoView({block:'nearest'}); } else it.classList.remove('active-suggestion'); }); };
        
        window.updateSuggestions = (val, type) => { 
            activeSuggestionIndex = -1; 
            const container = document.getElementById(type + 'Suggestions'); 
            const source = type === 'model' ? allModels : (currentModel ? Object.keys(priceStructure[currentModel]||{}) : []); 
            const matches = source.filter(i => i.toLowerCase().includes(val.toLowerCase())); 
            
            container.innerHTML = ''; 
            matches.forEach(i => { 
                const div = document.createElement('div'); 
                div.className = 'suggestion-item text-sm text-gray-700'; 
                div.textContent = i; 
                div.onclick = (e) => { e.stopPropagation(); selectItem(i, type); }; 
                container.appendChild(div); 
            }); 
            
            if(type === 'service' && source.length > 0) { 
                const div = document.createElement('div'); 
                div.className='show-all-item text-sm'; 
                div.innerText=`Hi·ªán t·∫•t c·∫£ (${source.length})`; 
                div.onclick = (e)=>{ e.stopPropagation(); showAllServices(); container.classList.add('hidden'); }; 
                container.appendChild(div); 
            } 
            
            container.classList.toggle('hidden', matches.length === 0 && (type !== 'service')); 
            
            const btnAdd = document.getElementById('add' + (type==='model'?'Model':'Service') + 'Button');
            const btnRename = document.getElementById('rename' + (type==='model'?'Model':'Service') + 'Button');
            const exact = source.includes(val);
            
            if(btnRename) updateButtonState(btnRename, exact);
            if(btnAdd) updateButtonState(btnAdd, val.trim().length > 0 && !exact);
        };

        window.selectItem = (val, type) => { 
            document.getElementById(type+'Input').value = val; 
            document.getElementById(type+'Suggestions').classList.add('hidden'); 
            
            if(type==='model') { 
                currentModel = val; 
                const sInput = document.getElementById('serviceInput');
                sInput.disabled = false; 
                sInput.value = ''; 
                sInput.focus(); 
                updateButtonState(document.getElementById('renameModelButton'), true);
                toggleTable(false); 
            } else { 
                updateButtonState(document.getElementById('renameServiceButton'), true);
                displayPriceTable(); 
            } 
        };
        
        window.showAllServices = () => { 
            if(!currentModel) return; 
            const svcs = Object.keys(priceStructure[currentModel]||{}).sort(); 
            document.getElementById('allServicesTitle').innerText = "Ch·ªçn D·ªãch V·ª•"; 
            const grid = document.getElementById('allServicesGrid'); 
            grid.innerHTML = ''; 
            
            svcs.forEach(s => { 
                const container = document.createElement('div');
                container.className = 'flex items-center gap-1 group';
                
                // Select Button
                const btn = document.createElement('button'); 
                btn.className = 'flex-grow bg-white border border-gray-200 text-gray-700 p-3 rounded shadow hover:bg-gray-50 text-left truncate'; 
                btn.innerText = s; 
                btn.onclick = () => { window.selectItem(s, 'service'); window.closeAllServicesModal(); }; 
                
                // Delete Button (Small Trash Icon)
                const delBtn = document.createElement('button');
                delBtn.className = 'flex-none bg-red-50 text-red-500 p-3 rounded border border-red-100 hover:bg-red-100 transition';
                delBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>';
                delBtn.onclick = (e) => { e.stopPropagation(); window.confirmDeleteGlobalService(s); };

                container.appendChild(btn);
                container.appendChild(delBtn);
                grid.appendChild(container); 
            }); 
            
            document.getElementById('allServicesModal').classList.remove('hidden'); 
            setTimeout(() => { 
                document.getElementById('allServicesModalContent').classList.remove('opacity-0', 'scale-95'); 
                document.getElementById('allServicesModalContent').classList.add('opacity-100', 'scale-100'); 
            }, 10); 
        };
        
        window.closeAllServicesModal = () => { document.getElementById('allServicesModal').classList.add('hidden'); };
        window.clearSuggestions = (e) => {};
        document.getElementById('editPriceInput').addEventListener('keyup', function() { let v=this.value.replace(/,/g,'').replace(/\D/g,''); if(v) this.value=parseInt(v).toLocaleString('en-US'); });

        const updateButtonState = (b, a) => { 
            b.disabled = !a; 
            if(a) b.classList.replace('bg-gray-100','bg-indigo-100') || b.classList.replace('bg-gray-200','bg-indigo-100'); 
            else b.classList.replace('bg-indigo-100','bg-gray-100') || b.classList.replace('bg-indigo-100','bg-gray-200');
            
            if(b.id.includes('Service')) {
                 if(a) b.classList.replace('bg-gray-200','bg-indigo-100'); 
                 else b.classList.replace('bg-indigo-100','bg-gray-200');
            }
        };

        if (typeof window.startFirebaseApp === 'function') window.startFirebaseApp();
    </script>
</body>
</html>